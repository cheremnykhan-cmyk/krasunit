// –§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏ —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ Telegram –∏ –¥–∞–Ω–Ω—ã–º–∏ –æ —Ä–∞—Å—á–µ—Ç–µ
document.getElementById('contactForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
  
  const form = e.target;
  const data = {
    city: form.city.value,
    phone: form.phone.value,
    email: form.email.value || '–Ω–µ —É–∫–∞–∑–∞–Ω',
    comments: form.comments.value || '–Ω–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–∂–µ–ª–∞–Ω–∏–π'
  };
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ä–∞—Å—á–µ—Ç–µ
  const foundationType = document.getElementById('foundationType').value;
  const length = document.getElementById('length').value;
  const width = document.getElementById('width').value;
  const height = document.getElementById('height').value;
  
  // –°—á–∏—Ç–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å (–∫–æ–ø–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ calculate)
  const area = length * width;
  const basePrice = area * 22500;
  const baseHeight = area <= 100 ? 3.5 : 6;
  const extra = Math.max(0, height - baseHeight);
  const buildingCost = basePrice * (1 + extra * 0.15);
  
  let foundationCost = 0;
  let foundationDetails = '';
  
  if (foundationType === 'lentochny') {
    const perimeter = parseFloat(document.getElementById('perimeter').value);
    const fHeight = parseFloat(document.getElementById('foundationHeight').value);
    const fWidth = parseFloat(document.getElementById('foundationWidth').value);
    
    const concreteVolume = perimeter * fHeight * fWidth;
    const rebarVolume = concreteVolume * 0.15;
    const rebarWeight = rebarVolume * 2.5;
    const concreteCost = concreteVolume * 9500;
    const rebarCost = rebarWeight * 80000;
    const workCost = concreteVolume * 19850;
    
    foundationCost = concreteCost + rebarCost + workCost;
    foundationDetails = `–õ–µ–Ω—Ç–æ—á–Ω—ã–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç: ${Math.round(foundationCost).toLocaleString('ru-RU')} ‚ÇΩ`;
  } 
  else if (foundationType === 'plita') {
    const slabLength = parseFloat(document.getElementById('slabLength').value);
    const slabWidth = parseFloat(document.getElementById('slabWidth').value);
    const slabHeight = parseFloat(document.getElementById('slabHeight').value);
    
    const concreteVolume = slabLength * slabWidth * slabHeight;
    const rebarVolume = concreteVolume * 0.15;
    const rebarWeight = rebarVolume * 2.5;
    const concreteCost = concreteVolume * 9500;
    const rebarCost = rebarWeight * 80000;
    const workCost = concreteVolume * 19850;
    
    foundationCost = concreteCost + rebarCost + workCost;
    foundationDetails = `–ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è –ø–ª–∏—Ç–∞: ${Math.round(foundationCost).toLocaleString('ru-RU')} ‚ÇΩ`;
  }
  else if (foundationType !== 'none') {
    foundationDetails = '–§—É–Ω–¥–∞–º–µ–Ω—Ç: –ø–æ –∑–∞–ø—Ä–æ—Å—É';
  }
  
  const totalCost = buildingCost + foundationCost;
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Ä–∞—Å—á–µ—Ç–µ
  const message = `üîî –ù–û–í–ê–Ø –ó–ê–Ø–í–ö–ê –° –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†–ê KRASUNIT!\n\n` +
                  `üìä –ü–ê–†–ê–ú–ï–¢–†–´ –†–ê–°–ß–ï–¢–ê:\n` +
                  `–†–∞–∑–º–µ—Ä—ã: ${length}√ó${width}√ó${height} –º\n` +
                  `–ü–ª–æ—â–∞–¥—å: ${area} –º¬≤\n` +
                  `–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–¥–∞–Ω–∏—è: ${Math.round(buildingCost).toLocaleString('ru-RU')} ‚ÇΩ\n` +
                  `${foundationDetails ? foundationDetails + '\n' : ''}` +
                  `–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${Math.round(totalCost).toLocaleString('ru-RU')} ‚ÇΩ\n\n` +
                  `üìû –ö–û–ù–¢–ê–ö–¢–ù–´–ï –î–ê–ù–ù–´–ï:\n` +
                  `–ì–û–†–û–î: ${data.city}\n` +
                  `–¢–ï–õ–ï–§–û–ù: ${data.phone}\n` +
                  `EMAIL: ${data.email}\n` +
                  `–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û: ${data.comments}`;
  
  // –û—Å–Ω–æ–≤–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
  fetch(`https://api.telegram.org/bot7958824238:AAGTyFNDncbhf_2BmJ7B30xt8BRog8MxPVw/sendMessage`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
        chat_id: '1399740836',  // ‚Üê –í–ê–® –õ–ò–ß–ù–´–ô ID –ò–ó @userinfobot
      text: message
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.ok) {
      alert(`‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞—è–≤–∫—É!\n–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤.\n–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${Math.round(totalCost).toLocaleString('ru-RU')} ‚ÇΩ`);
      form.reset();
    } else {
      throw new Error(data.description || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram');
    }
  })
  .catch(error => {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', error);
    
    // –†–µ–∑–µ—Ä–≤–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –ø–æ—á—Ç—É —á–µ—Ä–µ–∑ Formspree
    alert('Telegram –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∞—à—É –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ—á—Ç—É...');
    
    const formData = new FormData();
    formData.append('city', data.city);
    formData.append('phone', data.phone);
    formData.append('email', data.email);
    formData.append('comments', data.comments);
    formData.append('calculation', `–†–∞–∑–º–µ—Ä—ã: ${length}√ó${width}√ó${height} –º, –ò—Ç–æ–≥: ${Math.round(totalCost).toLocaleString('ru-RU')} ‚ÇΩ`);
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –ø–æ—á—Ç—É —á–µ—Ä–µ–∑ Formspree
    fetch('https://formspree.io/f/mjgollkd', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.ok) {
        alert(`‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞—è–≤–∫—É!\n–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞. –ú—ã —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –≤—ã—à–ª–µ–º —Ä–∞—Å—á–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤.`);
        form.reset();
      } else {
        throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –ø–æ—á—Ç—É');
      }
    })
    .catch(emailError => {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –ø–æ—á—Ç—É:', emailError);
      
      // –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      alert(`‚ö†Ô∏è –í–†–ï–ú–ï–ù–ù–´–ï –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´\n\n–í–∞—à–∞ –∑–∞—è–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ, –Ω–æ –º—ã –Ω–µ —Å–º–æ–≥–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –Ω–∞–ø—Ä—è–º—É—é:\n\nüìû +7 (391) 282-23-40\nüìß KrasUnit@mail.ru\nüí¨ Telegram: @krasunit_bot\n\n–ú—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤.`);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage
      const savedRequests = JSON.parse(localStorage.getItem('savedRequests') || '[]');
      savedRequests.push({
        timestamp: new Date().toISOString(),
        calculation: {
          length, width, height, area,
          buildingCost: Math.round(buildingCost),
          foundationCost: Math.round(foundationCost),
          totalCost: Math.round(totalCost)
        },
        contact: data
      });
      localStorage.setItem('savedRequests', JSON.stringify(savedRequests));
      
      form.reset();
    })
    .finally(() => {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '–ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—á—ë—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ';
    });
  })
  .finally(() => {
    submitBtn.disabled = false;
    submitBtn.innerHTML = '–ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—á—ë—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ';
  });
});